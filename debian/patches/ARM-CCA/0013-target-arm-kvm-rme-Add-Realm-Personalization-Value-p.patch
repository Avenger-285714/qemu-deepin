From 79ecdd15a4995b46904871fbe73519afd3f69944 Mon Sep 17 00:00:00 2001
From: Jean-Philippe Brucker <jean-philippe@linaro.org>
Date: Tue, 7 Feb 2023 18:55:22 +0000
Subject: [PATCH 13/29] target/arm/kvm-rme: Add Realm Personalization Value
 parameter
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Reference:https://git.codelinaro.org/linaro/dcap/qemu/-/commit/c2659aa7e7fde76a3bc9914f348ee5c2d7b4d15d

The Realm Personalization Value (RPV) is provided by the user to
distinguish Realms that have the same initial measurement.

The user provides a base64 string encoding 64 bytes. They are stored
into the RPV in the same order.

Cc: Eric Blake <eblake@redhat.com>
Cc: Markus Armbruster <armbru@redhat.com>
Cc: Daniel P. Berrang√© <berrange@redhat.com>
Cc: Eduardo Habkost <eduardo@habkost.net>
Acked-by: Markus Armbruster <armbru@redhat.com>
Signed-off-by: Jean-Philippe Brucker <jean-philippe@linaro.org>
Signed-off-by: houmingyong <houmingyong@huawei.com>
---
 qapi/qom.json        | 14 ++++++++
 target/arm/kvm-rme.c | 85 ++++++++++++++++++++++++++++++++++++++++++++
 2 files changed, 99 insertions(+)

diff --git a/qapi/qom.json b/qapi/qom.json
index cdb44375..b85bb467 100644
--- a/qapi/qom.json
+++ b/qapi/qom.json
@@ -909,6 +909,19 @@
   'data': { '*cpu-affinity': ['uint16'],
             '*node-affinity': ['uint16'] } }
 
+##
+# @RmeGuestProperties:
+#
+# Properties for rme-guest objects.
+#
+# @personalization-value: a base64 string encoding a 64-byte (512-bit) value.
+#     This optional parameter allows to uniquely identify the VM instance
+#     during attestation. (default: all-zero)
+#
+# Since: 10.0
+##
+{ 'struct': 'RmeGuestProperties',
+  'data': { '*personalization-value': 'str' } }
 
 ##
 # @ObjectType:
@@ -1025,6 +1038,7 @@
       'pr-manager-helper':          { 'type': 'PrManagerHelperProperties',
                                       'if': 'CONFIG_LINUX' },
       'qtest':                      'QtestProperties',
+      'rme-guest':                  'RmeGuestProperties',
       'rng-builtin':                'RngProperties',
       'rng-egd':                    'RngEgdProperties',
       'rng-random':                 { 'type': 'RngRandomProperties',
diff --git a/target/arm/kvm-rme.c b/target/arm/kvm-rme.c
index 1f421876..e8976e47 100644
--- a/target/arm/kvm-rme.c
+++ b/target/arm/kvm-rme.c
@@ -12,6 +12,7 @@
 #include "kvm_arm.h"
 #include "migration/blocker.h"
 #include "qapi/error.h"
+#include "qemu/base64.h"
 #include "qemu/error-report.h"
 #include "qom/object_interfaces.h"
 #include "exec/confidential-guest-support.h"
@@ -33,6 +34,9 @@ struct RmeGuest {
     Notifier rom_load_notifier;
     GSList *ram_regions;
 
+    char *personalization_value_str;
+    uint8_t personalization_value[ARM_RME_CONFIG_RPV_SIZE];
+
     RmeRamRegion init_ram;
 };
 
@@ -42,6 +46,48 @@ OBJECT_DEFINE_SIMPLE_TYPE_WITH_INTERFACES(RmeGuest, rme_guest, RME_GUEST,
 
 static RmeGuest *rme_guest;
 
+static int rme_configure_one(RmeGuest *guest, uint32_t cfg, Error **errp)
+{
+    int ret;
+    const char *cfg_str;
+    struct arm_rme_config args = {
+        .cfg = cfg,
+    };
+
+    switch (cfg) {
+    case ARM_RME_CONFIG_RPV:
+        memcpy(args.rpv, guest->personalization_value, ARM_RME_CONFIG_RPV_SIZE);
+        cfg_str = "personalization value";
+        break;
+    default:
+        g_assert_not_reached();
+    }
+
+    ret = kvm_vm_enable_cap(kvm_state, KVM_CAP_ARM_RME, 0,
+                            KVM_CAP_ARM_RME_CONFIG_REALM, (intptr_t)&args);
+    if (ret) {
+        error_setg_errno(errp, -ret, "failed to configure %s", cfg_str);
+    }
+    return ret;
+}
+
+static int rme_configure(Error **errp)
+{
+    int ret;
+    size_t option;
+    const uint32_t config_options[] = {
+        ARM_RME_CONFIG_RPV,
+    };
+
+    for (option = 0; option < ARRAY_SIZE(config_options); option++) {
+        ret = rme_configure_one(rme_guest, config_options[option], errp);
+        if (ret) {
+            return ret;
+        }
+    }
+    return 0;
+}
+
 static int rme_init_ram(RmeRamRegion *ram, Error **errp)
 {
     int ret;
@@ -122,6 +168,10 @@ static int rme_create_realm(Error **errp)
 {
     int ret;
 
+    if (rme_configure(errp)) {
+        return -1;
+    }
+
     ret = kvm_vm_enable_cap(kvm_state, KVM_CAP_ARM_RME, 0,
                             KVM_CAP_ARM_RME_CREATE_REALM);
     if (ret) {
@@ -167,8 +217,43 @@ static void rme_vm_state_change(void *opaque, bool running, RunState state)
     }
 }
 
+static char *rme_get_rpv(Object *obj, Error **errp)
+{
+    RmeGuest *guest = RME_GUEST(obj);
+
+    return g_strdup(guest->personalization_value_str);
+}
+
+static void rme_set_rpv(Object *obj, const char *value, Error **errp)
+{
+    RmeGuest *guest = RME_GUEST(obj);
+    g_autofree uint8_t *rpv = NULL;
+    size_t len;
+
+    rpv = qbase64_decode(value, -1, &len, errp);
+    if (!rpv) {
+        return;
+    }
+
+    if (len != sizeof(guest->personalization_value)) {
+        error_setg(errp,
+                   "expecting a Realm Personalization Value of size %zu, got %zu\n",
+                   sizeof(guest->personalization_value), len);
+        return;
+    }
+    memcpy(guest->personalization_value, rpv, len);
+
+    /* Save the value so we don't need to encode it in the getter */
+    g_free(guest->personalization_value_str);
+    guest->personalization_value_str = g_strdup(value);
+}
+
 static void rme_guest_class_init(ObjectClass *oc, void *data)
 {
+    object_class_property_add_str(oc, "personalization-value", rme_get_rpv,
+                                  rme_set_rpv);
+    object_class_property_set_description(oc, "personalization-value",
+            "Realm personalization value (64 bytes encodede in base64)");
 }
 
 static void rme_guest_init(Object *obj)
-- 
2.51.0

